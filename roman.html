<html><head><title>Bill Mill</title>
<link rel="stylesheet" href="css/960css/reset.css" />
<link rel="stylesheet" href="css/960css/960.css" />
<link rel="stylesheet" href="css/style.css" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head><body>
<div class="container_16">
    <div class="grid_3">
        <a href="http://billmill.org"><img src="images/logo.png" width="136" height="94"></a>
    </div>
    <div class="clear"></div>

    <div class="grid_13 prefix_3 content">
        <h1>Beautiful Code</h1>

        <p>This bit of code for converting numbers into their Roman numeral equivalents 
was posted by <a 
href="http://programming.reddit.com/info/658ys/comments/c02vm1j">geezusfreeek</a> 
on reddit, and I found it so alarmingly pretty that I'm going to spend some 
time to break it down.  This exercise is largely for my own edification, but 
perhaps somebody else will learn a bit along the way. Here's the code:

<p><div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">List</span>
<span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">Control.Arrow</span>

<span style="color: #06287e">romanize</span> <span style="color: #007020; font-weight: bold">=</span> concat <span style="color: #666666">.</span> unfoldr next
    <span style="color: #007020; font-weight: bold">where</span> next <span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Nothing</span>
          next x <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> second (x<span style="color: #666666">-</span>) <span style="color: #666666">$</span> head <span style="color: #666666">$</span> filter ((<span style="color: #666666">&lt;=</span>x) <span style="color: #666666">.</span> snd) numerals
          numerals <span style="color: #007020; font-weight: bold">=</span> [(<span style="color: #4070a0">&quot;M&quot;</span>, <span style="color: #40a070">1000</span>), (<span style="color: #4070a0">&quot;CM&quot;</span>, <span style="color: #40a070">900</span>), (<span style="color: #4070a0">&quot;D&quot;</span>, <span style="color: #40a070">500</span>), (<span style="color: #4070a0">&quot;CD&quot;</span>, <span style="color: #40a070">400</span>),
                      (<span style="color: #4070a0">&quot;C&quot;</span>, <span style="color: #40a070">100</span>),  (<span style="color: #4070a0">&quot;XC&quot;</span>, <span style="color: #40a070">90</span>),  (<span style="color: #4070a0">&quot;L&quot;</span>, <span style="color: #40a070">50</span>),  (<span style="color: #4070a0">&quot;XL&quot;</span>, <span style="color: #40a070">40</span>),
                      (<span style="color: #4070a0">&quot;X&quot;</span>, <span style="color: #40a070">10</span>),   (<span style="color: #4070a0">&quot;IX&quot;</span>, <span style="color: #40a070">9</span>),   (<span style="color: #4070a0">&quot;V&quot;</span>, <span style="color: #40a070">5</span>),   (<span style="color: #4070a0">&quot;IV&quot;</span>, <span style="color: #40a070">4</span>),
                      (<span style="color: #4070a0">&quot;I&quot;</span>, <span style="color: #40a070">1</span>)]
</pre></div>

<p>Starting from the inside out is usually the easiest method of understanding 
blocks like this, so we'll look first at the "numerals" list. It is, simply, a 
list of tuples matching Roman numerals to their value. Importantly, it's 
ordered from largest to smallest; we'll see why shortly.</p>
<p>The meat of this snippet comes in the "next" function:
<p><div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #06287e">next</span> <span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Nothing</span>
<span style="color: #06287e">next</span> x <span style="color: #007020; font-weight: bold">=</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> second (x<span style="color: #666666">-</span>) <span style="color: #666666">$</span> head <span style="color: #666666">$</span> filter ((<span style="color: #666666">&lt;=</span>x) <span style="color: #666666">.</span> snd) numerals
</pre></div>

<p>This function is going to return either Nothing (in the base case) or Just a 
tuple of type (String, Integer), where the string is the largest roman numeral 
that's smaller than x and the int is the difference between x and the value of 
that roman numeral.
<p>The first thing we do is filter out the numerals larger than x; we can run 
some quick tests at the interactive console to see how this works:
<p><div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #902000">Prelude</span><span style="color: #666666">&gt;</span> <span style="color: #007020; font-weight: bold">let</span> numerals <span style="color: #007020; font-weight: bold">=</span> [(<span style="color: #4070a0">&quot;M&quot;</span>, <span style="color: #40a070">1000</span>), (<span style="color: #4070a0">&quot;CM&quot;</span>, <span style="color: #40a070">900</span>), (<span style="color: #4070a0">&quot;D&quot;</span>, <span style="color: #40a070">500</span>)]
<span style="color: #902000">Prelude</span><span style="color: #666666">&gt;</span> filter ((<span style="color: #666666">&lt;=</span><span style="color: #40a070">900</span>) <span style="color: #666666">.</span> snd) numerals
[(<span style="color: #4070a0">&quot;CM&quot;</span>,<span style="color: #40a070">900</span>),(<span style="color: #4070a0">&quot;D&quot;</span>,<span style="color: #40a070">500</span>)]
</pre></div>

<p>We use head to grab the largest numeral we can squeeze into the current 
value:
<p><div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #902000">Prelude</span><span style="color: #666666">&gt;</span> head <span style="color: #666666">$</span> filter ((<span style="color: #666666">&lt;=</span><span style="color: #40a070">900</span>) <span style="color: #666666">.</span> snd) numerals 
(<span style="color: #4070a0">&quot;CM&quot;</span>,<span style="color: #40a070">900</span>)
</pre></div>

<p>Then we subtract the value of the roman numeral from the current value of x, 
in order to return the remainder to be operated on next:
<p><div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #902000">Prelude</span><span style="color: #666666">&gt;</span> <span style="color: #902000">:</span>m <span style="color: #902000">Control</span><span style="color: #666666">.</span><span style="color: #902000">Arrow</span>
<span style="color: #902000">Prelude</span> <span style="color: #902000">Control</span><span style="color: #666666">.</span><span style="color: #902000">Arrow</span><span style="color: #666666">&gt;</span> second (<span style="color: #40a070">900</span><span style="color: #666666">-</span>) <span style="color: #666666">$</span> head <span style="color: #666666">$</span> filter ((<span style="color: #666666">&lt;=</span><span style="color: #40a070">900</span>) <span style="color: #666666">.</span> snd) numerals
(<span style="color: #4070a0">&quot;CM&quot;</span>,<span style="color: #40a070">0</span>)
<span style="color: #902000">Prelude</span> <span style="color: #902000">Control</span><span style="color: #666666">.</span><span style="color: #902000">Arrow</span><span style="color: #666666">&gt;</span> second (<span style="color: #40a070">915</span><span style="color: #666666">-</span>) <span style="color: #666666">$</span> head <span style="color: #666666">$</span> filter ((<span style="color: #666666">&lt;=</span><span style="color: #40a070">915</span>) <span style="color: #666666">.</span> snd) numerals
(<span style="color: #4070a0">&quot;CM&quot;</span>,<span style="color: #40a070">15</span>)
</pre></div>

<p>And, finally, we wrap it up in a Maybe monad, so that the main function can 
handle the base case transparently:
<p><div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #902000">Prelude</span> <span style="color: #902000">Control</span><span style="color: #666666">.</span><span style="color: #902000">Arrow</span><span style="color: #666666">&gt;</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> second (<span style="color: #40a070">915</span><span style="color: #666666">-</span>)  <span style="color: #666666">$</span> head <span style="color: #666666">$</span> 
    filter ((<span style="color: #666666">&lt;=</span><span style="color: #40a070">915</span>) <span style="color: #666666">.</span>  snd) numerals
<span style="color: #902000">Just</span> (<span style="color: #4070a0">&quot;CM&quot;</span>,<span style="color: #40a070">15</span>)
</pre></div>

<p>And now we're getting pretty close! What we have is a function that returns 
either Nothing or a tuple containing a letter to add to our roman numeral and 
the next value to operate on. All we have left is the code to drive the 
operation:
<p><div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #06287e">romanize</span> <span style="color: #007020; font-weight: bold">=</span> concat <span style="color: #666666">.</span> unfoldr next
</pre></div>

<p>The use of unfoldr helps explain why we've wrapped next up in Maybe; here's 
its type:
<p><div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #902000">Prelude</span> <span style="color: #902000">Control</span><span style="color: #666666">.</span><span style="color: #902000">Arrow</span><span style="color: #666666">&gt;</span> <span style="color: #902000">:</span>m <span style="color: #902000">List</span>
<span style="color: #902000">Prelude</span> <span style="color: #902000">List</span><span style="color: #666666">&gt;</span> <span style="color: #902000">:</span>t unfoldr
<span style="color: #06287e">unfoldr</span> <span style="color: #007020; font-weight: bold">::</span> (b <span style="color: #007020; font-weight: bold">-&gt;</span> <span style="color: #902000">Maybe</span> (a, b)) <span style="color: #007020; font-weight: bold">-&gt;</span> b <span style="color: #007020; font-weight: bold">-&gt;</span> [a]
</pre></div>

<p>So we'll take a function from b -> Maybe (a, b), a value of type b, and 
return a list of [a]. In our case, a = String and b = Integer.
<p>All unfoldr does is call the function it's given as a first argument, which 
returns a tuple or Nothing. If it's a tuple, it appends its first element to a 
list and calls the same function with the second element. If it's Nothing, it 
returns the list it's built up to this point.
<p>As we can see, that matches up perfectly with the "next" function we've 
already defined, and the unfoldr will build up a list of roman numeral strings:
<p><div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #902000">Prelude</span><span style="color: #666666">&gt;</span> <span style="color: #902000">:</span>m <span style="color: #902000">Control</span><span style="color: #666666">.</span><span style="color: #902000">Arrow</span> <span style="color: #902000">List</span>
<span style="color: #902000">Prelude</span> <span style="color: #902000">Control</span><span style="color: #666666">.</span><span style="color: #902000">Arrow</span> <span style="color: #902000">List</span><span style="color: #666666">&gt;</span> <span style="color: #007020; font-weight: bold">let</span> numerals <span style="color: #007020; font-weight: bold">=</span> [(<span style="color: #4070a0">&quot;X&quot;</span>, <span style="color: #40a070">10</span>), (<span style="color: #4070a0">&quot;IX&quot;</span>, <span style="color: #40a070">9</span>), (<span style="color: #4070a0">&quot;V&quot;</span>, <span style="color: #40a070">5</span>), 
(<span style="color: #4070a0">&quot;IV&quot;</span>, <span style="color: #40a070">4</span>), (<span style="color: #4070a0">&quot;I&quot;</span>, <span style="color: #40a070">1</span>)]
<span style="color: #902000">Prelude</span> <span style="color: #902000">Control</span><span style="color: #666666">.</span><span style="color: #902000">Arrow</span> <span style="color: #902000">List</span><span style="color: #666666">&gt;</span> <span style="color: #007020; font-weight: bold">let</span> next x <span style="color: #007020; font-weight: bold">=</span> <span style="color: #007020; font-weight: bold">if</span> x<span style="color: #666666">==</span><span style="color: #40a070">0</span> <span style="color: #007020; font-weight: bold">then</span> <span style="color: #902000">Nothing</span>               
    <span style="color: #007020; font-weight: bold">else</span> <span style="color: #902000">Just</span> <span style="color: #666666">$</span> second (x<span style="color: #666666">-</span>) <span style="color: #666666">$</span> head <span style="color: #666666">$</span> filter ((<span style="color: #666666">&lt;=</span>x) <span style="color: #666666">.</span> snd) numerals
<span style="color: #902000">Prelude</span> <span style="color: #902000">Control</span><span style="color: #666666">.</span><span style="color: #902000">Arrow</span> <span style="color: #902000">List</span><span style="color: #666666">&gt;</span> unfoldr next <span style="color: #40a070">9</span>
[<span style="color: #4070a0">&quot;IX&quot;</span>]
<span style="color: #902000">Prelude</span> <span style="color: #902000">Control</span><span style="color: #666666">.</span><span style="color: #902000">Arrow</span> <span style="color: #902000">List</span><span style="color: #666666">&gt;</span> unfoldr next <span style="color: #40a070">8</span>
[<span style="color: #4070a0">&quot;V&quot;</span>,<span style="color: #4070a0">&quot;I&quot;</span>,<span style="color: #4070a0">&quot;I&quot;</span>,<span style="color: #4070a0">&quot;I&quot;</span>]
</pre></div>

<p>(We had to mangle the definition of next a bit to fit into the interactive 
interpreter, but we haven't changed anything fundamental about it.)
<p>Finally, all we have to do is concatenate the strings into our final result:
<p><div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #902000">Prelude</span> <span style="color: #902000">Control</span><span style="color: #666666">.</span><span style="color: #902000">Arrow</span> <span style="color: #902000">List</span><span style="color: #666666">&gt;</span> (concat <span style="color: #666666">.</span> unfoldr next) <span style="color: #40a070">8</span>
<span style="color: #4070a0">&quot;VIII&quot;</span>
</pre></div>

<p><h2>Conclusion</h2>
<p>Phew - that's an awful lot of information stuffed into a few pretty lines! I 
still have a hell of a time geting the types to match up so that I can write 
stuff like this, but that doesn't mean that I can't appreciate the beauty of 
how it all fits together. The original function presented here is tight in the 
very best sense of the word.


        <h4><a href="http://billmill.org/roman.html">Jan 12, 2008</a></h4>
    </div>

    <div class="grid_16 footer">
        Bill Mill • <a href="mailto:bill.mill@gmail.com">bill.mill@gmail.com</a>
    </div>
</div>
</body></html>
