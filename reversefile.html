<html><head><title>Bill Mill</title>
<link rel="stylesheet" href="css/960css/reset.css" />
<link rel="stylesheet" href="css/960css/960.css" />
<link rel="stylesheet" href="css/style.css" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head><body>
<div class="container_16">
    <div class="grid_3">
        <a href="http://billmill.org"><img src="images/logo.png" width="136" height="94"></a>
    </div>
    <div class="clear"></div>

    <div class="grid_13 prefix_3 content">
        <h1>Reverse File Iterator and Premature Optimization</h1>

        <p>This afternoon, I had a need for a reverse file iterator in a script I was 
writing to process a quite large log file. After some unsuccessful googling 
followed by some quick hacking, I was left with a frustratingly close, but 
nonfunctional, iterator. Instead of fixing it while I was at work, I hacked up 
a solution calling "tail" and left it for a while.

<p>When I came back to finish the job this evening, I figured that I ought to go 
look at the <a 
href="http://ftp.bg.openbsd.org/OpenBSD/src/usr.bin/tail/">source</a> of tail 
for some inspiration. Surely the unix hackers had figured this problem out long 
ago? In <a 
href="http://ftp.bg.openbsd.org/OpenBSD/src/usr.bin/tail/reverse.c">reverse.c</a>, 
I found the inspiration I needed:<p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%">    <span style="color: #007020; font-weight: bold">for</span> (; pos <span style="color: #666666">&gt;=</span> start; pos<span style="color: #666666">--</span>) {
        <span style="color: #60a0b0; font-style: italic">/* A seek per char isn&#39;t a problem with a smart stdio */</span>
        <span style="color: #007020; font-weight: bold">if</span> (fseeko(fp, pos, SEEK_SET) <span style="color: #666666">!=</span> <span style="color: #40a070">0</span>) {
        <span style="color: #60a0b0; font-style: italic">//snip</span>
            <span style="color: #007020; font-weight: bold">if</span> ((ch <span style="color: #666666">=</span> getc(fp)) <span style="color: #666666">==</span> <span style="border: 1px solid #FF0000">&#39;\</span>n<span style="border: 1px solid #FF0000">&#39;</span>)
</pre></div>
<p>
I had been reading the file in chunks, splitting the chunk into lines, handling 
a cache of the lines, and compensating for unfinished lines, all because I had 
buried deep down in my lizard brain the idea that an fseek per character was 
"slow". In pure python, for chrissake!<p>
Properly reminded of the fact that premature optimization can sneak up 
anywhere, I ended up with this code:<p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span style="color: #007020; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>

<span style="color: #007020; font-weight: bold">class</span> <span style="color: #0e84b5; font-weight: bold">reversefile</span>(<span style="color: #007020">object</span>):
    <span style="color: #4070a0; font-style: italic">&quot;&quot;&quot;Iterate backwards through a file. f should be an open file handle&quot;&quot;&quot;</span>
    <span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">__init__</span>(<span style="color: #007020">self</span>, f):
        <span style="color: #007020">self</span><span style="color: #666666">.</span>_f <span style="color: #666666">=</span> f
        <span style="color: #007020">self</span><span style="color: #666666">.</span>end <span style="color: #666666">=</span> os<span style="color: #666666">.</span>stat(f<span style="color: #666666">.</span>name)<span style="color: #666666">.</span>st_size

    <span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">__iter__</span>(<span style="color: #007020">self</span>): <span style="color: #007020; font-weight: bold">return</span> <span style="color: #007020">self</span>

    <span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">next</span>(<span style="color: #007020">self</span>):
        <span style="color: #007020; font-weight: bold">if</span> <span style="color: #007020">self</span><span style="color: #666666">.</span>end <span style="color: #666666">==</span> <span style="color: #40a070">0</span>:
            <span style="color: #007020; font-weight: bold">raise</span> <span style="color: #007020">StopIteration</span>

        pos <span style="color: #666666">=</span> <span style="color: #007020">self</span><span style="color: #666666">.</span>end<span style="color: #666666">-</span><span style="color: #40a070">2</span>
        <span style="color: #007020; font-weight: bold">while</span> pos <span style="color: #666666">&gt;=</span> <span style="color: #40a070">0</span>:
            <span style="color: #007020">self</span><span style="color: #666666">.</span>_f<span style="color: #666666">.</span>seek(pos)
            <span style="color: #007020; font-weight: bold">if</span> <span style="color: #007020">self</span><span style="color: #666666">.</span>_f<span style="color: #666666">.</span>read(<span style="color: #40a070">1</span>) <span style="color: #666666">==</span> <span style="color: #4070a0">&#39;</span><span style="color: #4070a0; font-weight: bold">\</span><span style="color: #4070a0">n&#39;</span>:
                end <span style="color: #666666">=</span> <span style="color: #007020">self</span><span style="color: #666666">.</span>end
                <span style="color: #007020">self</span><span style="color: #666666">.</span>end <span style="color: #666666">=</span> pos
                <span style="color: #007020; font-weight: bold">return</span> <span style="color: #007020">self</span><span style="color: #666666">.</span>_f<span style="color: #666666">.</span>read(end <span style="color: #666666">-</span> pos <span style="color: #666666">-</span> <span style="color: #40a070">1</span>)
            pos <span style="color: #666666">-=</span> <span style="color: #40a070">1</span>

        end <span style="color: #666666">=</span> <span style="color: #007020">self</span><span style="color: #666666">.</span>end
        <span style="color: #007020">self</span><span style="color: #666666">.</span>end <span style="color: #666666">=</span> <span style="color: #40a070">0</span>
        <span style="color: #007020">self</span><span style="color: #666666">.</span>_f<span style="color: #666666">.</span>seek(<span style="color: #40a070">0</span>)
        <span style="color: #007020; font-weight: bold">return</span> <span style="color: #007020">self</span><span style="color: #666666">.</span>_f<span style="color: #666666">.</span>read(end)<span style="color: #666666">.</span>strip(<span style="color: #4070a0">&quot;</span><span style="color: #4070a0; font-weight: bold">\</span><span style="color: #4070a0">n&quot;</span>)
</pre></div>
<p>
You can see the whole thing, with source and some very brief tests I hacked up, 
<a 
href="http://billmill.org:9561/personal_code/browser/python/reversefile/reversefile.py?rev=57">here</a>.


        <h4><a href="http://billmill.org/reversefile.html">Oct 03, 2007</a></h4>
    </div>

    <div class="grid_16 footer">
        Bill Mill â€¢ <a href="mailto:bill.mill@gmail.com">bill.mill@gmail.com</a>
    </div>
</div>
</body></html>
