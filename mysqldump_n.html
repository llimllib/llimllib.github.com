<html><head><title>Bill Mill</title>
<link rel="stylesheet" href="css/960css/reset.css" />
<link rel="stylesheet" href="css/960css/960.css" />
<link rel="stylesheet" href="css/style.css" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head><body>
<div class="container_16">
    <div class="grid_3">
        <a href="http://billmill.org"><img src="images/logo.png" width="136" height="94"></a>
    </div>
    <div class="clear"></div>

    <div class="grid_13 prefix_3 content">
        <h1>MySQL Partial Dump</h1>

        <p>At work, I'm trying to bring our testing from its current ad-hoc state into 
something more useful. Priority #1 at the moment is making what limited 
test suite we have into a practical, repeatable test of our main code 
library.<p>

To do so, however, I need to create script to import a useful subset of the 
data from our nine gigabyte MySQL production database into a local 
database.  Unfortunately, mysqldump seems not to support the export of only 
N rows from a database table, and neither does there seem to be a standard 
way to do so. In fact, there seems to be no standard way to <a 
href="http://forums.mysql.com/read.php?20,159999,159999">automatically 
generate  insert queries</a>, so it's not even possible to hack it with 
OUTFILE tricks.<p>
Indeed, a quick look look at the mysqldump <a 
href="http://mysql.bkbits.net:8080/mysql-5.2/client/mysqldump.c?PAGE=anno&REV=%2b">source 
code</a> shows that it just constructs a query of the form: "SELECT * FROM 
<em>table</em> [WHERE <em>condition</em>] [ORDER BY <em>field</em>]":<p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span>dynstr_append_checked(<span style="color: #666666">&amp;</span>query_string, 
    <span style="color: #4070a0">&quot;SELECT /*!40001 SQL_NO_CACHE */ * FROM &quot;</span>);
dynstr_append_checked(<span style="color: #666666">&amp;</span>query_string, result_table);

<span style="color: #007020; font-weight: bold">if</span> (where)
{
  <span style="color: #60a0b0; font-style: italic">/* snip */</span>
  dynstr_append_checked(<span style="color: #666666">&amp;</span>query_string, <span style="color: #4070a0">&quot; WHERE &quot;</span>);
  dynstr_append_checked(<span style="color: #666666">&amp;</span>query_string, where);
}
<span style="color: #007020; font-weight: bold">if</span> (order_by)
{
  <span style="color: #60a0b0; font-style: italic">/* snip */</span>
  dynstr_append_checked(<span style="color: #666666">&amp;</span>query_string, <span style="color: #4070a0">&quot; ORDER BY &quot;</span>);
  dynstr_append_checked(<span style="color: #666666">&amp;</span>query_string, order_by);
}
</pre></div>
<p>
And then pieces together an insert string manually:<p>
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #007020; font-weight: bold">while</span> ((row<span style="color: #666666">=</span> mysql_fetch_row(res)))
{
<span style="color: #60a0b0; font-style: italic">/* snip */</span>
  <span style="color: #007020; font-weight: bold">for</span> (i<span style="color: #666666">=</span> <span style="color: #40a070">0</span>; i <span style="color: #666666">&lt;</span> mysql_num_fields(res); i<span style="color: #666666">++</span>)
  {
    <span style="color: #60a0b0; font-style: italic">/* snip */</span>
    <span style="color: #007020; font-weight: bold">if</span> (row[i])
    {
      <span style="color: #007020; font-weight: bold">if</span> (<span style="color: #666666">!</span>IS_NUM_FIELD(field))
      {
        <span style="color: #60a0b0; font-style: italic">/* snip */</span>
        unescape(md_result_file, row[i], length);
        <span style="color: #60a0b0; font-style: italic">/* snip */</span>
      }
      <span style="color: #007020; font-weight: bold">else</span>
      {
        <span style="color: #60a0b0; font-style: italic">/* change any strings (&quot;inf&quot;, &quot;-inf&quot;, &quot;nan&quot;) into NULL */</span>
        <span style="color: #902000">char</span> <span style="color: #666666">*</span>ptr<span style="color: #666666">=</span> row[i];
        <span style="color: #60a0b0; font-style: italic">/* snip */</span>
        <span style="color: #007020; font-weight: bold">else</span> <span style="color: #06287e">if</span> (my_isalpha(charset_info, <span style="color: #666666">*</span>ptr) <span style="color: #666666">||</span>
                 (<span style="color: #666666">*</span>ptr <span style="color: #666666">==</span> <span style="color: #4070a0">&#39;-&#39;</span> <span style="color: #666666">&amp;&amp;</span> my_isalpha(charset_info, ptr[<span style="color: #40a070">1</span>])))
          fputs(<span style="color: #4070a0">&quot;NULL&quot;</span>, md_result_file);
        <span style="color: #007020; font-weight: bold">else</span> <span style="color: #06287e">if</span> (field<span style="color: #666666">-&gt;</span>type <span style="color: #666666">==</span> MYSQL_TYPE_DECIMAL)
        {
          <span style="color: #60a0b0; font-style: italic">/* add &quot; signs around */</span>
          fputc(<span style="color: #4070a0">&#39;\&#39;&#39;</span>, md_result_file);
          fputs(ptr, md_result_file);
          fputc(<span style="color: #4070a0">&#39;\&#39;&#39;</span>, md_result_file);
        }
        <span style="color: #007020; font-weight: bold">else</span>
          <span style="color: #06287e">fputs</span>(ptr, md_result_file);
      }
    }
  }
}
</pre></div>
<p>
So, rather than deal with hacking the rather baroque C (in a proprietary 
source control that I've never used, no less) to add another option to 
limit output rows, I threw together a little python function that uses <a 
href="http://sourceforge.net/projects/mysql-python">MySQLdb</a> to do what 
I want:
<div class="highlight" style="background: #f0f0f0"><pre style="line-height: 125%"><span></span><span style="color: #4070a0; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #4070a0; font-style: italic">get_n_rows retrieves n rows from a given table on MySQLdb connection conn</span>

<span style="color: #4070a0; font-style: italic">conn:  open MySQLdb connection object</span>
<span style="color: #4070a0; font-style: italic">table: string; name of the table which we are generating queries for</span>
<span style="color: #4070a0; font-style: italic">n:     int; number of rows to output from table</span>

<span style="color: #4070a0; font-style: italic">Legal kwargs:</span>
<span style="color: #4070a0; font-style: italic">    reverse: bool; whether to return rows in reverse order (requires idCol)</span>
<span style="color: #4070a0; font-style: italic">    idCol:   string; results will be sorted on this column if reverse is </span>
<span style="color: #4070a0; font-style: italic">             True</span>
<span style="color: #4070a0; font-style: italic">    where:   string; provides the &quot;where&quot; clause of the select query</span>
<span style="color: #4070a0; font-style: italic">             NOTE: escape this text yourself! use connection.escape() .</span>

<span style="color: #4070a0; font-style: italic">Released under WTFPL (http://sam.zoy.org/wtfpl/) - use this code as you </span>
<span style="color: #4070a0; font-style: italic">wish. Note that it&#39;s not tested at all, and certainly won&#39;t handle blob </span>
<span style="color: #4070a0; font-style: italic">fields. That said, it worked for my purposes today.</span>

<span style="color: #4070a0; font-style: italic">bill.mill@gmail.com 8/17/07</span>
<span style="color: #4070a0; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #007020; font-weight: bold">def</span> <span style="color: #06287e">get_n_rows</span>(conn, table, n, <span style="color: #666666">**</span>kwargs):
    cur <span style="color: #666666">=</span> conn<span style="color: #666666">.</span>cursor()

    <span style="color: #60a0b0; font-style: italic">#TODO: copy mysqldump&#39;s table escaping function</span>
    sql <span style="color: #666666">=</span> <span style="color: #4070a0">&quot;select * from `</span><span style="color: #70a0d0; font-style: italic">%s</span><span style="color: #4070a0">` &quot;</span> <span style="color: #666666">%</span> (table)
    <span style="color: #007020; font-weight: bold">if</span> <span style="color: #4070a0">&quot;where&quot;</span> <span style="color: #007020; font-weight: bold">in</span> kwargs:
        sql <span style="color: #666666">+=</span> <span style="color: #4070a0">&quot;where </span><span style="color: #70a0d0; font-style: italic">%s</span><span style="color: #4070a0"> &quot;</span> <span style="color: #666666">%</span> (kwargs[<span style="color: #4070a0">&quot;where&quot;</span>])
    <span style="color: #007020; font-weight: bold">if</span> <span style="color: #4070a0">&quot;reverse&quot;</span> <span style="color: #007020; font-weight: bold">in</span> kwargs <span style="color: #007020; font-weight: bold">and</span> kwargs[<span style="color: #4070a0">&quot;reverse&quot;</span>]:
        sql <span style="color: #666666">+=</span> <span style="color: #4070a0">&quot;order by `</span><span style="color: #70a0d0; font-style: italic">%s</span><span style="color: #4070a0">` desc &quot;</span> <span style="color: #666666">%</span> (kwargs[<span style="color: #4070a0">&quot;idCol&quot;</span>])
    sql <span style="color: #666666">+=</span> <span style="color: #4070a0">&quot;limit </span><span style="color: #70a0d0; font-style: italic">%s</span><span style="color: #4070a0">;&quot;</span>
    cur<span style="color: #666666">.</span>execute(sql, (n, ))

    i <span style="color: #666666">=</span> <span style="color: #40a070">0</span>
    row <span style="color: #666666">=</span> cur<span style="color: #666666">.</span>fetchone()
    insert_stmts <span style="color: #666666">=</span> [] 
    <span style="color: #007020; font-weight: bold">while</span> row <span style="color: #007020; font-weight: bold">and</span> i <span style="color: #666666">&lt;</span> n:
        i <span style="color: #666666">+=</span> <span style="color: #40a070">1</span>
        <span style="color: #60a0b0; font-style: italic">#note that the MySQLdb source suggests that conn.literal is </span>
        <span style="color: #60a0b0; font-style: italic"># private; I see no problem with using it, as it just loads the </span>
        <span style="color: #60a0b0; font-style: italic"># default escaping functions. Caveat Emptor.</span>
        strow <span style="color: #666666">=</span> <span style="color: #4070a0">&quot;, &quot;</span><span style="color: #666666">.</span>join([conn<span style="color: #666666">.</span>literal(o) <span style="color: #007020; font-weight: bold">for</span> o <span style="color: #007020; font-weight: bold">in</span> row])
        insert_stmts<span style="color: #666666">.</span>append(<span style="color: #4070a0">&quot;(</span><span style="color: #70a0d0; font-style: italic">%s</span><span style="color: #4070a0">)&quot;</span> <span style="color: #666666">%</span> (strow))
        row <span style="color: #666666">=</span> cur<span style="color: #666666">.</span>fetchone()

    cur<span style="color: #666666">.</span>close()
    
    <span style="color: #007020; font-weight: bold">return</span> <span style="color: #4070a0">&quot;&quot;&quot;</span>
<span style="color: #4070a0">-------- INSERT DATA FOR TABLE </span><span style="color: #70a0d0; font-style: italic">%(table)s</span><span style="color: #4070a0"> -----------</span>
<span style="color: #4070a0">    </span>
<span style="color: #4070a0">    LOCK TABLES `</span><span style="color: #70a0d0; font-style: italic">%(table)s</span><span style="color: #4070a0">` WRITE;</span>
<span style="color: #4070a0">    DELETE FROM `</span><span style="color: #70a0d0; font-style: italic">%(table)s</span><span style="color: #4070a0">`;</span>
<span style="color: #4070a0">    INSERT INTO `</span><span style="color: #70a0d0; font-style: italic">%(table)s</span><span style="color: #4070a0">` VALUES </span><span style="color: #70a0d0; font-style: italic">%(sql)s</span><span style="color: #4070a0">;</span>
<span style="color: #4070a0">    UNLOCK TABLES;</span>

<span style="color: #4070a0">-------- END INSERT DATA FOR TABLE </span><span style="color: #70a0d0; font-style: italic">%(table)s</span><span style="color: #4070a0"> -----------</span>
<span style="color: #4070a0">&quot;&quot;&quot;</span> <span style="color: #666666">%</span> {<span style="color: #4070a0">&quot;table&quot;</span>: table, <span style="color: #4070a0">&quot;sql&quot;</span>: <span style="color: #4070a0">&quot;,&quot;</span><span style="color: #666666">.</span>join(insert_stmts)}
</pre></div>
<p>
On a side note, the MySQLdb docs are somewhat hard to track down; I found 
them after some effort <a 
href="http://mysql-python.sourceforge.net/MySQLdb.html">here</a>.


        <h4><a href="http://billmill.org/mysqldump_n.html">Aug 17, 2007</a></h4>
    </div>

    <div class="grid_16 footer">
        Bill Mill • <a href="mailto:bill.mill@gmail.com">bill.mill@gmail.com</a>
    </div>
</div>
</body></html>
